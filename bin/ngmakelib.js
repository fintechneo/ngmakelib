#!/usr/bin/env node
"use strict";function inlineResourcesForDirectory(e){glob.sync(path.join(e,"**/*.ts")).forEach(function(e){return inlineResources(e)})}function inlineResources(e){console.log("Inlining resources",e);var t=fs.readFileSync(e,"utf-8");t=removeModuleId(t=inlineStyles(t=inlineTemplate(t,e),e)),fs.writeFileSync(e,t,"utf-8")}function inlineTemplate(e,t){return e.replace(/templateUrl:\s*["']([^']+?\.html)["']/g,function(e,n){return'template: "'+loadResourceFile(path.join(path.dirname(t),n))+'"'})}function inlineStyles(fileContent,filePath){return fileContent.replace(/styleUrls:\s*(\[[\s\S]*?])/gm,function(_match,styleUrlsValue){var styleUrls=eval(styleUrlsValue),styleContents=styleUrls.map(function(e){return path.join(path.dirname(filePath),e)}).map(function(e){return loadResourceFile(e)});return'styles: ["'+styleContents.join(" ")+'"]'})}function removeModuleId(e){return e.replace(/\s*moduleId:\s*module\.id\s*,?\s*/gm,"")}function loadResourceFile(e){return console.log("Inlining resource",e),fs.readFileSync(e,"utf-8").replace(/([\n\r]\s*)+/gm," ").replace(/"/g,'\\"')}function build(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,rollup.rollup(inputOptions)];case 1:return e=t.sent(),[4,e.write(outputOptions)];case 2:return t.sent(),[2]}})})}var path=require("path"),fs=require("fs"),glob=require("glob"),shell=require("shelljs"),rollup=require("rollup"),AngularCompilerConfig=function(){function e(){this.config={compilerOptions:{target:"es5",module:"es2015",moduleResolution:"node",sourceMap:!0,emitDecoratorMetadata:!0,experimentalDecorators:!0,declaration:!0,lib:["es2015","dom"],suppressImplicitAnyIndexErrors:!0},files:[],angularCompilerOptions:{annotationsAs:"decorators",genDir:"build",flatModuleOutFile:null,flatModuleId:null,skipTemplateCodegen:!0,annotateForClosureCompiler:!0,strictMetadataEmit:!0}}}return e.prototype.getConfig=function(e,t,n){return this.config.files[0]=e,this.config.compilerOptions.outDir=t,this.config.angularCompilerOptions.flatModuleOutFile=n+".js",this.config.angularCompilerOptions.flatModuleId=n,this.config},e}(),PackageJSONConfig=function(){function e(){}return e.prototype.getConfig=function(e){return{name:e,version:"0.1.0",main:e+".js",types:e+".d.ts"}},e}(),__awaiter=function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function l(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(l,s)}u((r=r.apply(e,t||[])).next())})},__generator=function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,o&&(l=o[2&n[0]?"return":n[0]?"throw":"next"])&&!(l=l.call(o,n[1])).done)return l;switch(o=0,l&&(n=[0,l.value]),n[0]){case 0:case 1:l=n;break;case 4:return u.label++,{value:n[1],done:!1};case 5:u.label++,o=n[1],n=[0];continue;case 7:n=u.ops.pop(),u.trys.pop();continue;default:if(l=u.trys,!(l=l.length>0&&l[l.length-1])&&(6===n[0]||2===n[0])){u=0;continue}if(3===n[0]&&(!l||n[1]>l[0]&&n[1]<l[3])){u.label=n[1];break}if(6===n[0]&&u.label<l[1]){u.label=l[1],l=n;break}if(l&&u.label<l[2]){u.label=l[2],u.ops.push(n);break}l[2]&&u.ops.pop(),u.trys.pop();continue}n=t.call(e,u)}catch(e){n=[6,e],o=0}finally{i=l=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,l,s,u={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},libsrc=process.argv[2],moduleId=process.argv[3],liborigsrcdir=libsrc.substring(0,libsrc.lastIndexOf("/")),srcfile=libsrc.substring(libsrc.lastIndexOf("/")+1),tmpdir=".ngmakelibtmp";shell.exec("rm -Rf "+tmpdir),fs.mkdirSync(tmpdir),shell.exec("cp -r "+liborigsrcdir+" "+tmpdir+"/src"),inlineResourcesForDirectory(tmpdir);var config=(new AngularCompilerConfig).getConfig("src/"+srcfile,"build",moduleId);fs.writeFileSync(tmpdir+"/tsconfig.json",JSON.stringify(config)),shell.exec("node_modules/.bin/ngc -p "+tmpdir+"/tsconfig.json");var inputOptions={input:tmpdir+"/build/"+moduleId+".js"},outputOptions={file:tmpdir+"/dist/"+moduleId+".js",format:"es"};build().then(function(){shell.exec('./node_modules/.bin/cpx "'+tmpdir+'/build/**/*.d.ts" "'+tmpdir+'/dist"'),shell.exec("cp "+tmpdir+"/build/*.metadata.json "+tmpdir+"/dist/"),fs.writeFileSync(tmpdir+"/dist/package.json",JSON.stringify((new PackageJSONConfig).getConfig(moduleId),null,1)),shell.exec("cd "+tmpdir+"/dist && tar -zcvf ../../"+moduleId+".tar.gz ."),shell.exec("rm -Rf "+tmpdir),console.log("All done")});
