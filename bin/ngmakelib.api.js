"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var path=require("path"),fs=require("fs"),glob=require("glob"),nodeSass=require("node-sass"),Observable=require("rxjs/Observable");require("rxjs/observable/of"),require("rxjs/operators");var child_process=require("child_process"),shelljs=require("shelljs"),rollup=require("rollup"),cpx=require("cpx"),resourceSourceFileRefs={};function inlineResourcesForDirectory(e){glob.sync(path.join(e,"**/*.ts")).forEach(function(e){return inlineResources(e)})}function inlineResources(e){console.log("Inlining resources",e);var i=fs.readFileSync(e,"utf-8");i=removeModuleId(i=inlineStyles(i=inlineTemplate(i,e),e)),fs.writeFileSync(e,i,"utf-8")}function inlineResourcesAsync(e){return new Observable.Observable(function(i){fs.readFile(e,"utf-8",function(r,s){s=removeModuleId(s=inlineStyles(s=inlineTemplate(s,e),e)),fs.writeFile(e,s,{encoding:"utf-8"},function(){console.log("Inlined resources",e),i.next(s)})})})}function inlineTemplate(e,i){return e.replace(/templateUrl:\s*["']([^']+?\.html)["']/g,function(e,r){var s=path.join(path.dirname(i),r),t=loadResourceFile(s);return addResourceSourceFileRef(i,s),'template: "'+t+'"'})}function addResourceSourceFileRef(e,i){resourceSourceFileRefs[i]||(resourceSourceFileRefs[i]={}),resourceSourceFileRefs[i][e]=!0}function getAffectedTypeScriptSourceFilesForResource(e){return resourceSourceFileRefs[e]?Object.keys(resourceSourceFileRefs[e]):[]}function inlineStyles(fileContent,filePath){return fileContent.replace(/styleUrls:\s*(\[[\s\S]*?])/gm,function(_match,styleUrlsValue){var styleUrls=eval(styleUrlsValue),styleContents=styleUrls.map(function(e){return path.join(path.dirname(filePath),e)}).map(function(e){return addResourceSourceFileRef(filePath,e),e.endsWith(".scss")?nodeSass.renderSync({file:e}).css.toString().replace(/([\n\r]\s*)+/gm," ").replace(/"/g,'\\"'):loadResourceFile(e)});return'styles: ["'+styleContents.join(" ")+'"]'})}function removeModuleId(e){return e.replace(/\s*moduleId:\s*module\.id\s*,?\s*/gm,"")}function loadResourceFile(e){return console.log("Inlining resource",e),fs.readFileSync(e,"utf-8").replace(/([\n\r]\s*)+/gm," ").replace(/"/g,'\\"')}var AngularCompilerConfig=function(){function e(){this.config={compilerOptions:{target:"es5",module:"es2015",moduleResolution:"node",sourceMap:!0,emitDecoratorMetadata:!0,experimentalDecorators:!0,declaration:!0,lib:["es2015","dom"],suppressImplicitAnyIndexErrors:!0},files:[],angularCompilerOptions:{annotationsAs:"decorators",flatModuleOutFile:null,flatModuleId:null,skipTemplateCodegen:!0,annotateForClosureCompiler:!0,strictMetadataEmit:!0}}}return e.prototype.getConfig=function(e,i,r){return this.config.files[0]=e,this.config.compilerOptions.outDir=i,this.config.angularCompilerOptions.flatModuleOutFile=r+".js",this.config.angularCompilerOptions.flatModuleId=r,this.config},e}(),PackageJSONConfig=function(){function e(){}return e.prototype.getConfig=function(e,i){if(!i)try{i=JSON.parse(fs.readFileSync("package.json").toString()).version}catch(e){i="0.1.0",console.log("Defaulting to version {{version}} since no version were provided, and couldn't find version in package.json of your project")}return{name:e,version:i,main:e+".js",types:e+".d.ts"}},e}(),NGMakeLib=function(){function e(e,i,r){this.libsrc=e,this.moduleId=i,this.version=r,this.tmpdir=".ngmakelibtmp",this.liborigsrcdir=e.substring(0,e.lastIndexOf("/")),this.srcfile=e.substring(e.lastIndexOf("/")+1),this.ngcConfig=(new AngularCompilerConfig).getConfig("src/"+this.srcfile,"build",this.moduleId),this.packageJSONConfig=(new PackageJSONConfig).getConfig(i,r),this.version=this.packageJSONConfig.version,this.rollupInputOptions={input:this.tmpdir+"/build/"+this.moduleId+".js"},this.rollupOutputOptions={file:this.tmpdir+"/dist/"+this.moduleId+".js",format:"es"}}return e.prototype.watch=function(){var e=this;fs.existsSync(this.tmpdir)||fs.mkdirSync(this.tmpdir),fs.existsSync(this.tmpdir+"/build")||fs.mkdirSync(this.tmpdir+"/build"),this.ngcConfig.angularCompilerOptions.generateCodeForLibraries=!1,fs.writeFileSync(this.tmpdir+"/tsconfig.json",JSON.stringify(this.ngcConfig)),fs.writeFileSync(this.tmpdir+"/build/package.json",JSON.stringify(this.packageJSONConfig,null,1));var i=cpx.watch(this.liborigsrcdir+"/**",this.tmpdir+"/src/");i.on("watch-error",function(e){return console.log(e)}),i.on("watch-ready",function(){inlineResourcesForDirectory(e.tmpdir+"/src"),i.on("copy",function(i){var r=i.srcPath.substring(e.liborigsrcdir.length+1);r.indexOf(".ts")>0?inlineResourcesAsync(e.tmpdir+"/src/"+r).subscribe():[".css",".scss",".html"].find(function(e){return r.indexOf(e)>-1})&&getAffectedTypeScriptSourceFilesForResource(e.tmpdir+"/src/"+r).forEach(function(i){fs.copyFile(e.liborigsrcdir+"/"+i.substring((e.tmpdir+"/src/").length),i,function(){return inlineResourcesAsync(i).subscribe()})})});var r=child_process.exec('"node_modules/.bin/ngc" -w -p '+e.tmpdir+"/tsconfig.json");r.stdout.pipe(process.stdout),r.stderr.pipe(process.stderr)})},e.prototype.build=function(){var e=this;return shelljs.exec("rm -Rf "+this.tmpdir),fs.mkdirSync(this.tmpdir),shelljs.exec("cp -r "+this.liborigsrcdir+" "+this.tmpdir+"/src"),inlineResourcesForDirectory(this.tmpdir),fs.writeFileSync(this.tmpdir+"/tsconfig.json",JSON.stringify(this.ngcConfig)),shelljs.exec('"node_modules/.bin/ngc" -p '+this.tmpdir+"/tsconfig.json"),rollup.rollup(this.rollupInputOptions).then(function(i){return i.write(e.rollupOutputOptions)}).then(function(){shelljs.exec('"node_modules/.bin/cpx" "'+e.tmpdir+'/build/**/*.d.ts" "'+e.tmpdir+'/dist"'),shelljs.exec("cp "+e.tmpdir+"/build/*.metadata.json "+e.tmpdir+"/dist/"),fs.writeFileSync(e.tmpdir+"/dist/package.json",JSON.stringify(e.packageJSONConfig,null,1)),shelljs.exec("cd "+e.tmpdir+"/dist && tar -zcvf ../../"+e.moduleId+"-"+e.version+".tar.gz .")})},e}();exports.NGMakeLib=NGMakeLib;
