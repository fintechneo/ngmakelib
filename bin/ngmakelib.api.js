"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var path=require("path"),fs=require("fs"),glob=require("glob"),nodeSass=require("node-sass"),shelljs=require("shelljs"),rollup=require("rollup");function inlineResourcesForDirectory(e){glob.sync(path.join(e,"**/*.ts")).forEach(function(e){return inlineResources(e)})}function inlineResources(e){console.log("Inlining resources",e);var i=fs.readFileSync(e,"utf-8");i=removeModuleId(i=inlineStyles(i=inlineTemplate(i,e),e)),fs.writeFileSync(e,i,"utf-8")}function inlineTemplate(e,i){return e.replace(/templateUrl:\s*["']([^']+?\.html)["']/g,function(e,t){return'template: "'+loadResourceFile(path.join(path.dirname(i),t))+'"'})}function inlineStyles(fileContent,filePath){return fileContent.replace(/styleUrls:\s*(\[[\s\S]*?])/gm,function(_match,styleUrlsValue){var styleUrls=eval(styleUrlsValue),styleContents=styleUrls.map(function(e){return path.join(path.dirname(filePath),e)}).map(function(e){return e.endsWith(".scss")?nodeSass.renderSync({file:e}).css.toString().replace(/([\n\r]\s*)+/gm," ").replace(/"/g,'\\"'):loadResourceFile(e)});return'styles: ["'+styleContents.join(" ")+'"]'})}function removeModuleId(e){return e.replace(/\s*moduleId:\s*module\.id\s*,?\s*/gm,"")}function loadResourceFile(e){return console.log("Inlining resource",e),fs.readFileSync(e,"utf-8").replace(/([\n\r]\s*)+/gm," ").replace(/"/g,'\\"')}var AngularCompilerConfig=function(){function e(){this.config={compilerOptions:{target:"es5",module:"es2015",moduleResolution:"node",sourceMap:!0,emitDecoratorMetadata:!0,experimentalDecorators:!0,declaration:!0,lib:["es2015","dom"],suppressImplicitAnyIndexErrors:!0},files:[],angularCompilerOptions:{annotationsAs:"decorators",genDir:"build",flatModuleOutFile:null,flatModuleId:null,skipTemplateCodegen:!0,annotateForClosureCompiler:!0,strictMetadataEmit:!0}}}return e.prototype.getConfig=function(e,i,t){return this.config.files[0]=e,this.config.compilerOptions.outDir=i,this.config.angularCompilerOptions.flatModuleOutFile=t+".js",this.config.angularCompilerOptions.flatModuleId=t,this.config},e}(),PackageJSONConfig=function(){function e(){}return e.prototype.getConfig=function(e,i){if(!i)try{i=JSON.parse(fs.readFileSync("package.json").toString()).version}catch(e){i="0.1.0",console.log("Defaulting to version {{version}} since no version were provided, and couldn't find version in package.json of your project")}return{name:e,version:i,main:e+".js",types:e+".d.ts"}},e}(),NGMakeLib=function(){function e(e,i,t){this.libsrc=e,this.moduleId=i,this.version=t,this.tmpdir=".ngmakelibtmp",this.liborigsrcdir=e.substring(0,e.lastIndexOf("/")),this.srcfile=e.substring(e.lastIndexOf("/")+1),this.ngcConfig=(new AngularCompilerConfig).getConfig("src/"+this.srcfile,"build",this.moduleId),this.packageJSONConfig=(new PackageJSONConfig).getConfig(i,t),this.rollupInputOptions={input:this.tmpdir+"/build/"+this.moduleId+".js"},this.rollupOutputOptions={file:this.tmpdir+"/dist/"+this.moduleId+".js",format:"es"}}return e.prototype.build=function(){var e=this;return shelljs.exec("rm -Rf "+this.tmpdir),fs.mkdirSync(this.tmpdir),shelljs.exec("cp -r "+this.liborigsrcdir+" "+this.tmpdir+"/src"),inlineResourcesForDirectory(this.tmpdir),fs.writeFileSync(this.tmpdir+"/tsconfig.json",JSON.stringify(this.ngcConfig)),shelljs.exec('"node_modules/.bin/ngc" -p '+this.tmpdir+"/tsconfig.json"),rollup.rollup(this.rollupInputOptions).then(function(i){return i.write(e.rollupOutputOptions)}).then(function(){shelljs.exec('"node_modules/.bin/cpx" "'+e.tmpdir+'/build/**/*.d.ts" "'+e.tmpdir+'/dist"'),shelljs.exec("cp "+e.tmpdir+"/build/*.metadata.json "+e.tmpdir+"/dist/"),fs.writeFileSync(e.tmpdir+"/dist/package.json",JSON.stringify(e.packageJSONConfig,null,1)),shelljs.exec("cd "+e.tmpdir+"/dist && tar -zcvf ../../"+e.moduleId+"-"+e.version+".tar.gz ."),shelljs.exec("rm -Rf "+e.tmpdir)})},e}();exports.NGMakeLib=NGMakeLib;
